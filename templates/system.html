{{define "title"}}{{.System.Name}}{{end}}

{{define "content"}}
<div class="page-header">
    <a href="/" class="back-link">&larr; Back to Dashboard</a>
    <div class="system-title">
        <div class="status-indicator large {{statusClass .System.Status}}"></div>
        <h1>{{.System.Name}}</h1>
        <span class="status-badge {{statusClass .System.Status}}">{{statusIcon .System.Status}}</span>
    </div>
    {{if .System.Description}}
    <p class="description">{{.System.Description}}</p>
    {{end}}
    <div class="system-info">
        {{if .System.Owner}}<span class="info-item"><strong>Owner:</strong> {{.System.Owner}}</span>{{end}}
        {{if .System.URL}}<a href="{{.System.URL}}" target="_blank" class="btn btn-small">Open System</a>{{end}}
    </div>
</div>

<div class="detail-grid">
    <section class="card">
        <h2>Update Status</h2>
        <form id="statusForm" class="status-form">
            <div class="status-buttons">
                <button type="button" class="status-btn green {{if eq .System.Status.String "green"}}active{{end}}" data-status="green">
                    Operational
                </button>
                <button type="button" class="status-btn yellow {{if eq .System.Status.String "yellow"}}active{{end}}" data-status="yellow">
                    Degraded
                </button>
                <button type="button" class="status-btn red {{if eq .System.Status.String "red"}}active{{end}}" data-status="red">
                    Outage
                </button>
            </div>
            <textarea name="message" placeholder="Status update message (optional)..." rows="3"></textarea>
            <button type="submit" class="btn btn-primary">Update Status</button>
        </form>
    </section>

    {{if .Analytics}}
    <section class="card">
        <h2>Analytics (24h)</h2>
        <div class="analytics-grid">
            <div class="metric">
                <span class="metric-value">{{printf "%.2f" .Analytics.UptimePercent}}%</span>
                <span class="metric-label">Uptime</span>
            </div>
            <div class="metric">
                <span class="metric-value">{{.Analytics.TotalIncidents}}</span>
                <span class="metric-label">Incidents</span>
            </div>
            <div class="metric">
                <span class="metric-value">{{.Analytics.OngoingIncidents}}</span>
                <span class="metric-label">Ongoing</span>
            </div>
        </div>
    </section>
    {{end}}
</div>

{{if .Dependencies}}
<section class="card">
    <h2>Dependencies</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Status</th>
                <th>Heartbeat</th>
                <th>Last Check</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Dependencies}}
            <tr>
                <td>
                    <span class="status-dot {{statusClass .Status}}"></span>
                    {{.Name}}
                </td>
                <td>
                    <span class="status-badge small {{statusClass .Status}}">{{statusIcon .Status}}</span>
                </td>
                <td>
                    {{if .HeartbeatURL}}
                    <span class="heartbeat-active">Active</span>
                    <small>{{.HeartbeatURL}}</small>
                    {{else}}
                    <span class="heartbeat-inactive">Not configured</span>
                    {{end}}
                </td>
                <td>
                    {{if not .LastCheck.IsZero}}
                    {{.LastCheck.Format "15:04:05"}}
                    {{else}}
                    Never
                    {{end}}
                </td>
                <td>
                    <button class="btn btn-small" onclick="updateDepStatus({{.ID}})">Update</button>
                    {{if .HeartbeatURL}}
                    <button class="btn btn-small" onclick="forceCheck({{.ID}})">Check Now</button>
                    {{end}}
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</section>
{{end}}

{{if .Logs}}
<section class="card">
    <h2>Recent Activity</h2>
    <table class="data-table logs-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Change</th>
                <th>Message</th>
                <th>Source</th>
            </tr>
        </thead>
        <tbody>
            {{range .Logs}}
            <tr>
                <td>{{.CreatedAt.Format "2006-01-02 15:04:05"}}</td>
                <td>
                    <span class="status-dot {{statusClass .OldStatus}}"></span>
                    &rarr;
                    <span class="status-dot {{statusClass .NewStatus}}"></span>
                </td>
                <td>{{if .Message}}{{.Message}}{{else}}-{{end}}</td>
                <td><span class="source-badge {{.Source}}">{{.Source}}</span></td>
            </tr>
            {{end}}
        </tbody>
    </table>
</section>
{{end}}
{{end}}

{{define "scripts"}}
<script>
const systemId = {{.System.ID}};
let selectedStatus = '{{.System.Status.String}}';

document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedStatus = btn.dataset.status;
    });
});

document.getElementById('statusForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = e.target.message.value;

    try {
        const res = await fetch(`/api/systems/${systemId}/status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: selectedStatus, message})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to update status');
        }
    } catch (err) {
        alert('Network error');
    }
});

async function updateDepStatus(depId) {
    const status = prompt('Enter status (green, yellow, red):');
    if (!status) return;

    const message = prompt('Enter message (optional):') || '';

    try {
        const res = await fetch(`/api/dependencies/${depId}/status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status, message})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to update status');
        }
    } catch (err) {
        alert('Network error');
    }
}

async function forceCheck(depId) {
    try {
        const res = await fetch(`/api/dependencies/${depId}/check`, {method: 'POST'});
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Check failed');
        }
    } catch (err) {
        alert('Network error');
    }
}
</script>
{{end}}
