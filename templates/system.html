{{define "title"}}{{.System.Name}}{{end}}

{{define "content"}}
<div class="page-header">
    <a href="/" class="back-link">&larr; Back to Dashboard</a>
    <div class="system-title">
        <div class="status-indicator large {{statusClass .System.Status}}"></div>
        <h1>{{.System.Name}}</h1>
        <span class="status-badge {{statusClass .System.Status}}">{{statusIcon .System.Status}}</span>
    </div>
    {{if .System.Description}}
    <p class="description">{{.System.Description}}</p>
    {{end}}
    <div class="system-info">
        {{if .System.Owner}}<span class="info-item"><strong>Owner:</strong> {{.System.Owner}}</span>{{end}}
        {{if .System.URL}}<a href="{{.System.URL}}" target="_blank" class="btn btn-small">Open System</a>{{end}}
    </div>
</div>

<div class="detail-grid">
    <section class="card">
        <h2>Update Status</h2>
        <form id="statusForm" class="status-form">
            <div class="status-buttons">
                <button type="button" class="status-btn green {{if eq .System.Status.String "green"}}active{{end}}" data-status="green">
                    Operational
                </button>
                <button type="button" class="status-btn yellow {{if eq .System.Status.String "yellow"}}active{{end}}" data-status="yellow">
                    Degraded
                </button>
                <button type="button" class="status-btn red {{if eq .System.Status.String "red"}}active{{end}}" data-status="red">
                    Outage
                </button>
            </div>
            <textarea name="message" placeholder="Status update message (optional)..." rows="3"></textarea>
            <button type="submit" class="btn btn-primary">Update Status</button>
        </form>
    </section>

    {{if .Analytics}}
    <section class="card">
        <h2>Analytics (24h)</h2>
        <div class="analytics-grid">
            <div class="metric">
                <span class="metric-value">{{printf "%.2f" .Analytics.UptimePercent}}%</span>
                <span class="metric-label">Uptime</span>
            </div>
            <div class="metric">
                <span class="metric-value">{{.Analytics.TotalIncidents}}</span>
                <span class="metric-label">Incidents</span>
            </div>
            <div class="metric">
                <span class="metric-value">{{.Analytics.OngoingIncidents}}</span>
                <span class="metric-label">Ongoing</span>
            </div>
        </div>
    </section>
    {{end}}
</div>

{{if .Dependencies}}
<section class="card">
    <h2>Dependencies</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Status</th>
                <th>Heartbeat</th>
                <th>Last Check</th>
                <th>Latency</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Dependencies}}
            <tr class="dep-row" data-id="{{.ID}}" data-name="{{.Name}}" data-description="{{.Description}}" data-status="{{.Status.String}}" data-heartbeat-url="{{.HeartbeatURL}}" data-heartbeat-interval="{{.HeartbeatInterval}}">
                <td>
                    <span class="status-dot {{statusClass .Status}}"></span>
                    {{.Name}}
                </td>
                <td>
                    <span class="status-badge small {{statusClass .Status}}">{{statusIcon .Status}}</span>
                </td>
                <td>
                    {{if .HeartbeatURL}}
                    <span class="heartbeat-active">Active</span>
                    <small>{{.HeartbeatURL}}</small>
                    {{else}}
                    <span class="heartbeat-inactive">Not configured</span>
                    {{end}}
                </td>
                <td>
                    {{if not .LastCheck.IsZero}}
                    {{.LastCheck.Format "15:04:05"}}
                    {{else}}
                    Never
                    {{end}}
                </td>
                <td>
                    {{if .HeartbeatURL}}
                    <span class="latency-value">{{.LastLatency}}ms</span>
                    {{else}}
                    -
                    {{end}}
                </td>
                <td>
                    <button class="btn btn-small" onclick="openDepModal(this.closest('.dep-row'))">Update</button>
                    <button class="btn btn-small" onclick="openHeartbeatModal(this.closest('.dep-row'))">Heartbeat</button>
                    {{if .HeartbeatURL}}
                    <button class="btn btn-small" onclick="forceCheck({{.ID}})">Check Now</button>
                    {{end}}
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</section>
{{end}}

<!-- Update Dependency Modal -->
<div id="depModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>Update Dependency</h3>
        <form id="depForm" class="admin-form">
            <input type="hidden" id="depId">
            <div class="form-row">
                <input type="text" id="depName" placeholder="Name" required>
            </div>
            <div class="form-row">
                <input type="text" id="depDescription" placeholder="Description (optional)">
            </div>
            <div class="form-row">
                <label>Status:</label>
                <div class="status-buttons small">
                    <button type="button" class="status-btn green" data-status="green">Operational</button>
                    <button type="button" class="status-btn yellow" data-status="yellow">Degraded</button>
                    <button type="button" class="status-btn red" data-status="red">Outage</button>
                </div>
            </div>
            <div class="form-row">
                <input type="text" id="depMessage" placeholder="Status change message (optional)">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Heartbeat Configuration Modal -->
<div id="heartbeatModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>Configure Heartbeat</h3>
        <form id="heartbeatForm" class="admin-form">
            <input type="hidden" id="heartbeatDepId">
            <div class="form-row">
                <input type="url" id="heartbeatUrl" placeholder="Health check URL (leave empty to disable)">
            </div>
            <div class="form-row">
                <input type="number" id="heartbeatInterval" placeholder="Interval (seconds)" min="10" value="60">
            </div>
            <p class="form-hint">The URL will be checked periodically. HTTP 2xx = healthy, other = unhealthy.</p>
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" onclick="clearHeartbeat()">Disable</button>
                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

{{if .Logs}}
<section class="card">
    <h2>Recent Activity</h2>
    <table class="data-table logs-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Change</th>
                <th>Message</th>
                <th>Source</th>
            </tr>
        </thead>
        <tbody>
            {{range .Logs}}
            <tr>
                <td>{{.CreatedAt.Format "2006-01-02 15:04:05"}}</td>
                <td>
                    <span class="status-dot {{statusClass .OldStatus}}"></span>
                    &rarr;
                    <span class="status-dot {{statusClass .NewStatus}}"></span>
                </td>
                <td>{{if .Message}}{{.Message}}{{else}}-{{end}}</td>
                <td><span class="source-badge {{.Source}}">{{.Source}}</span></td>
            </tr>
            {{end}}
        </tbody>
    </table>
</section>
{{end}}
{{end}}

{{define "scripts"}}
<script>
const systemId = {{.System.ID}};
let selectedStatus = '{{.System.Status.String}}';

document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedStatus = btn.dataset.status;
    });
});

document.getElementById('statusForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = e.target.message.value;

    try {
        const res = await fetch(`/api/systems/${systemId}/status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: selectedStatus, message})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to update status');
        }
    } catch (err) {
        alert('Network error');
    }
});

let modalDepStatus = 'green';

function openDepModal(row) {
    document.getElementById('depId').value = row.dataset.id;
    document.getElementById('depName').value = row.dataset.name;
    document.getElementById('depDescription').value = row.dataset.description || '';
    document.getElementById('depMessage').value = '';
    modalDepStatus = row.dataset.status;

    // Update status buttons
    document.querySelectorAll('#depModal .status-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.status === modalDepStatus);
    });

    document.getElementById('depModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('depModal').style.display = 'none';
    document.getElementById('heartbeatModal').style.display = 'none';
}

// Status button handlers in modal
document.querySelectorAll('#depModal .status-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('#depModal .status-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        modalDepStatus = btn.dataset.status;
    });
});

// Close modal on outside click
document.getElementById('depModal').addEventListener('click', (e) => {
    if (e.target.id === 'depModal') closeModal();
});

// Form submission
document.getElementById('depForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('depId').value;
    const name = document.getElementById('depName').value;
    const description = document.getElementById('depDescription').value;
    const message = document.getElementById('depMessage').value;

    try {
        // Update name/description
        const updateRes = await fetch(`/api/dependencies/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description})
        });

        if (!updateRes.ok) {
            const data = await updateRes.json();
            alert(data.error || 'Failed to update dependency');
            return;
        }

        // Update status
        const statusRes = await fetch(`/api/dependencies/${id}/status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: modalDepStatus, message})
        });

        if (statusRes.ok) {
            location.reload();
        } else {
            const data = await statusRes.json();
            alert(data.error || 'Failed to update status');
        }
    } catch (err) {
        alert('Network error');
    }
});

async function forceCheck(depId) {
    try {
        const res = await fetch(`/api/dependencies/${depId}/check`, {method: 'POST'});
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Check failed');
        }
    } catch (err) {
        alert('Network error');
    }
}

// Heartbeat Modal
function openHeartbeatModal(row) {
    document.getElementById('heartbeatDepId').value = row.dataset.id;
    document.getElementById('heartbeatUrl').value = row.dataset.heartbeatUrl || '';
    document.getElementById('heartbeatInterval').value = row.dataset.heartbeatInterval || '60';
    document.getElementById('heartbeatModal').style.display = 'flex';
}

async function clearHeartbeat() {
    const id = document.getElementById('heartbeatDepId').value;
    try {
        const res = await fetch(`/api/dependencies/${id}/heartbeat`, {method: 'DELETE'});
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to clear heartbeat');
        }
    } catch (err) {
        alert('Network error');
    }
}

document.getElementById('heartbeatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('heartbeatDepId').value;
    const url = document.getElementById('heartbeatUrl').value;
    const interval = parseInt(document.getElementById('heartbeatInterval').value, 10);

    if (!url) {
        await clearHeartbeat();
        return;
    }

    if (!interval || interval < 10) {
        alert('Interval must be at least 10 seconds');
        return;
    }

    try {
        const res = await fetch(`/api/dependencies/${id}/heartbeat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url, interval})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to configure heartbeat');
        }
    } catch (err) {
        alert('Network error');
    }
});

document.getElementById('heartbeatModal').addEventListener('click', (e) => {
    if (e.target.id === 'heartbeatModal') closeModal();
});
</script>
{{end}}
