{{define "title"}}Admin{{end}}

{{define "content"}}
<div class="page-header">
    <h1>Administration</h1>
</div>

<section class="card">
    <h2>Backup & Restore</h2>
    <div class="backup-actions">
        <div class="backup-group">
            <h4>Export Data</h4>
            <p class="backup-desc">Download all systems, dependencies, and history as JSON file.</p>
            <div class="backup-buttons">
                <a href="/api/export" class="btn btn-primary" download>Export All</a>
                <a href="/api/export/logs" class="btn btn-small" download>Export Logs Only</a>
            </div>
        </div>
        <div class="backup-group">
            <h4>Import Data</h4>
            <p class="backup-desc">Restore data from a previously exported JSON file.</p>
            <div class="backup-buttons">
                <input type="file" id="importFile" accept=".json" style="display:none">
                <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">Import from File</button>
            </div>
        </div>
    </div>
    <div id="importResult" class="import-result" style="display:none"></div>
</section>

<section class="card">
    <h2>Webhooks</h2>
    <p class="section-desc">Configure webhooks to receive notifications when system status changes.</p>

    <div id="webhooksList" class="webhooks-list">
        <div class="loading">Loading webhooks...</div>
    </div>

    <button class="btn btn-primary" onclick="openAddWebhookModal()">Add Webhook</button>
</section>

<!-- Add Webhook Modal -->
<div id="addWebhookModal" class="modal" style="display:none">
    <div class="modal-content modal-wide">
        <h3>Add Webhook</h3>
        <form id="addWebhookForm" class="admin-form">
            <div class="form-row">
                <input type="text" id="addWebhookName" placeholder="Webhook name" required>
                <select id="addWebhookType">
                    <option value="generic">Generic HTTP</option>
                    <option value="slack">Slack</option>
                    <option value="telegram">Telegram</option>
                    <option value="discord">Discord</option>
                    <option value="teams">Microsoft Teams</option>
                </select>
            </div>
            <div class="form-row">
                <input type="url" id="addWebhookUrl" placeholder="Webhook URL" required style="flex:2">
            </div>
            <div class="form-row">
                <label class="checkbox-label">
                    <input type="checkbox" id="addWebhookEnabled" checked>
                    Enabled
                </label>
            </div>
            <div class="form-hint">
                <strong>URL examples:</strong><br>
                Slack: https://hooks.slack.com/services/XXX/YYY/ZZZ<br>
                Telegram: https://api.telegram.org/bot&lt;TOKEN&gt;/sendMessage?chat_id=&lt;CHAT_ID&gt;<br>
                Discord: https://discord.com/api/webhooks/XXX/YYY<br>
                Teams: https://outlook.office.com/webhook/XXX/IncomingWebhook/YYY/ZZZ
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="closeModal('addWebhookModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Webhook Modal -->
<div id="editWebhookModal" class="modal" style="display:none">
    <div class="modal-content modal-wide">
        <h3>Edit Webhook</h3>
        <form id="editWebhookForm" class="admin-form">
            <input type="hidden" id="editWebhookId">
            <div class="form-row">
                <input type="text" id="editWebhookName" placeholder="Webhook name" required>
                <select id="editWebhookType">
                    <option value="generic">Generic HTTP</option>
                    <option value="slack">Slack</option>
                    <option value="telegram">Telegram</option>
                    <option value="discord">Discord</option>
                    <option value="teams">Microsoft Teams</option>
                </select>
            </div>
            <div class="form-row">
                <input type="url" id="editWebhookUrl" placeholder="Webhook URL" required style="flex:2">
            </div>
            <div class="form-row">
                <label class="checkbox-label">
                    <input type="checkbox" id="editWebhookEnabled">
                    Enabled
                </label>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="closeModal('editWebhookModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<section class="card">
    <h2>Add New System</h2>
    <form id="addSystemForm" class="admin-form">
        <div class="form-row">
            <input type="text" name="name" placeholder="System name" required>
            <input type="text" name="description" placeholder="Description (optional)">
        </div>
        <div class="form-row">
            <input type="url" name="url" placeholder="System URL (optional)">
            <input type="text" name="owner" placeholder="Owner/Team (optional)">
        </div>
        <button type="submit" class="btn btn-primary">Add System</button>
    </form>
</section>

<!-- Edit System Modal -->
<div id="editModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>Edit System</h3>
        <form id="editSystemForm" class="admin-form">
            <input type="hidden" id="editSystemId">
            <div class="form-row">
                <input type="text" id="editName" placeholder="System name" required>
                <input type="text" id="editDescription" placeholder="Description (optional)">
            </div>
            <div class="form-row">
                <input type="url" id="editUrl" placeholder="System URL (optional)">
                <input type="text" id="editOwner" placeholder="Owner/Team (optional)">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="closeModal('editModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Dependency Modal -->
<div id="addDepModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>Add Dependency</h3>
        <form id="addDepForm" class="admin-form">
            <input type="hidden" id="addDepSystemId">
            <div class="form-row">
                <input type="text" id="addDepName" placeholder="Dependency name" required>
            </div>
            <div class="form-row">
                <input type="text" id="addDepDescription" placeholder="Description (optional)">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="closeModal('addDepModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Dependency Modal -->
<div id="editDepModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>Edit Dependency</h3>
        <form id="editDepForm" class="admin-form">
            <input type="hidden" id="editDepId">
            <div class="form-row">
                <input type="text" id="editDepName" placeholder="Dependency name" required>
            </div>
            <div class="form-row">
                <input type="text" id="editDepDescription" placeholder="Description (optional)">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="closeModal('editDepModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Heartbeat Configuration Modal -->
<div id="heartbeatModal" class="modal" style="display:none">
    <div class="modal-content" style="max-width: 600px;">
        <h3>Configure Heartbeat</h3>
        <form id="heartbeatForm" class="admin-form">
            <input type="hidden" id="heartbeatDepId">

            <div class="form-row" style="display: flex; gap: 10px;">
                <select id="heartbeatMethod" style="width: 100px;">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="HEAD">HEAD</option>
                </select>
                <input type="url" id="heartbeatUrl" placeholder="Health check URL" style="flex: 1;">
            </div>

            <div class="form-row" style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: 12px; color: #666;">Interval (sec)</label>
                    <input type="number" id="heartbeatInterval" placeholder="60" min="10" value="60">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 12px; color: #666;">Expected Status</label>
                    <input type="text" id="heartbeatExpectStatus" placeholder="2xx (default)">
                </div>
            </div>

            <details style="margin-bottom: 15px;">
                <summary style="cursor: pointer; color: #0066cc; font-size: 14px;">Advanced Options</summary>
                <div style="padding: 10px 0;">
                    <div class="form-row">
                        <label style="font-size: 12px; color: #666;">Custom Headers (JSON)</label>
                        <textarea id="heartbeatHeaders" placeholder='{"Authorization": "Bearer xxx"}' rows="2" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div class="form-row" id="bodyRow">
                        <label style="font-size: 12px; color: #666;">Request Body (for POST/PUT)</label>
                        <textarea id="heartbeatBody" placeholder='{"check": "health"}' rows="2" style="font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div class="form-row">
                        <label style="font-size: 12px; color: #666;">Response Body Regex</label>
                        <input type="text" id="heartbeatExpectBody" placeholder='"status":\s*"ok"'>
                    </div>
                </div>
            </details>

            <p class="form-hint">
                Expected status: "200", "200,201,204", or "2xx" (default).<br>
                Response regex validates that the body matches the pattern.
            </p>
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" onclick="clearHeartbeat()">Disable</button>
                <button type="button" class="btn" onclick="closeModal('heartbeatModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

{{if .Systems}}
<section class="card">
    <h2>Manage Systems</h2>
    {{range .Systems}}
    <div class="admin-system" data-id="{{.ID}}" data-name="{{.Name}}" data-description="{{.Description}}" data-url="{{.URL}}" data-owner="{{.Owner}}">
        <div class="admin-system-header">
            <span class="status-dot {{statusClass .Status}}"></span>
            <strong>{{.Name}}</strong>
            {{if .Owner}}<span class="owner-badge">{{.Owner}}</span>{{end}}
            {{if .URL}}<a href="{{.URL}}" target="_blank" class="url-link">Link</a>{{end}}
            <div class="admin-actions">
                <button class="btn btn-small" onclick="openEditModal(this.closest('.admin-system'))">Edit</button>
                <button class="btn btn-small btn-danger" onclick="deleteSystem({{.ID}}, '{{.Name}}')">Delete</button>
            </div>
        </div>

        <div class="admin-dependencies">
            <div class="dep-header">
                <h4>Dependencies</h4>
                <button class="btn btn-small" onclick="openAddDepModal({{.ID}})">+ Add</button>
            </div>

            {{if .Dependencies}}
            <ul class="admin-dep-list">
                {{range .Dependencies}}
                <li class="dep-item-admin" data-id="{{.ID}}" data-name="{{.Name}}" data-description="{{.Description}}"
                    data-heartbeat-url="{{.HeartbeatURL}}" data-heartbeat-interval="{{.HeartbeatInterval}}"
                    data-heartbeat-method="{{.HeartbeatMethod}}" data-heartbeat-headers="{{headersJSON .HeartbeatHeaders}}"
                    data-heartbeat-body="{{.HeartbeatBody}}" data-heartbeat-expect-status="{{.HeartbeatExpectStatus}}"
                    data-heartbeat-expect-body="{{.HeartbeatExpectBody}}">
                    <span class="status-dot {{statusClass .Status}}"></span>
                    <span class="dep-name">{{.Name}}</span>
                    {{if .HeartbeatURL}}
                    <span class="heartbeat-badge" title="{{.HeartbeatMethod}} {{.HeartbeatURL}}">HB: {{.HeartbeatInterval}}s</span>
                    {{end}}
                    <div class="dep-actions">
                        <button class="btn btn-tiny" onclick="openEditDepModal(this.closest('.dep-item-admin'))">Edit</button>
                        <button class="btn btn-tiny" onclick="openHeartbeatModal(this.closest('.dep-item-admin'))">Heartbeat</button>
                        <button class="btn btn-tiny btn-danger" onclick="deleteDependency({{.ID}}, '{{.Name}}')">Delete</button>
                    </div>
                </li>
                {{end}}
            </ul>
            {{else}}
            <p class="no-deps">No dependencies configured</p>
            {{end}}
        </div>
    </div>
    {{end}}
</section>
{{end}}
{{end}}

{{define "scripts"}}
<script>
document.getElementById('addSystemForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = e.target.name.value;
    const description = e.target.description.value;
    const url = e.target.url.value;
    const owner = e.target.owner.value;

    try {
        const res = await fetch('/api/systems', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description, url, owner})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to create system');
        }
    } catch (err) {
        alert('Network error');
    }
});

function openEditModal(systemEl) {
    document.getElementById('editSystemId').value = systemEl.dataset.id;
    document.getElementById('editName').value = systemEl.dataset.name;
    document.getElementById('editDescription').value = systemEl.dataset.description || '';
    document.getElementById('editUrl').value = systemEl.dataset.url || '';
    document.getElementById('editOwner').value = systemEl.dataset.owner || '';
    document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

document.getElementById('editSystemForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editSystemId').value;
    const name = document.getElementById('editName').value;
    const description = document.getElementById('editDescription').value;
    const url = document.getElementById('editUrl').value;
    const owner = document.getElementById('editOwner').value;

    try {
        const res = await fetch(`/api/systems/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description, url, owner})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to update system');
        }
    } catch (err) {
        alert('Network error');
    }
});

// Close modal on outside click
document.getElementById('editModal').addEventListener('click', (e) => {
    if (e.target.id === 'editModal') closeEditModal();
});

async function deleteSystem(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"? This will also delete all its dependencies.`)) return;

    try {
        const res = await fetch(`/api/systems/${id}`, {method: 'DELETE'});
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to delete system');
        }
    } catch (err) {
        alert('Network error');
    }
}

// Generic modal close function
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Add Dependency Modal
function openAddDepModal(systemId) {
    document.getElementById('addDepSystemId').value = systemId;
    document.getElementById('addDepName').value = '';
    document.getElementById('addDepDescription').value = '';
    document.getElementById('addDepModal').style.display = 'flex';
}

document.getElementById('addDepForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const systemId = document.getElementById('addDepSystemId').value;
    const name = document.getElementById('addDepName').value;
    const description = document.getElementById('addDepDescription').value;

    try {
        const res = await fetch(`/api/systems/${systemId}/dependencies`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to create dependency');
        }
    } catch (err) {
        alert('Network error');
    }
});

document.getElementById('addDepModal').addEventListener('click', (e) => {
    if (e.target.id === 'addDepModal') closeModal('addDepModal');
});

// Edit Dependency Modal
function openEditDepModal(depEl) {
    document.getElementById('editDepId').value = depEl.dataset.id;
    document.getElementById('editDepName').value = depEl.dataset.name;
    document.getElementById('editDepDescription').value = depEl.dataset.description || '';
    document.getElementById('editDepModal').style.display = 'flex';
}

document.getElementById('editDepForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editDepId').value;
    const name = document.getElementById('editDepName').value;
    const description = document.getElementById('editDepDescription').value;

    try {
        const res = await fetch(`/api/dependencies/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to update dependency');
        }
    } catch (err) {
        alert('Network error');
    }
});

document.getElementById('editDepModal').addEventListener('click', (e) => {
    if (e.target.id === 'editDepModal') closeModal('editDepModal');
});

// Heartbeat Configuration Modal
function openHeartbeatModal(depEl) {
    document.getElementById('heartbeatDepId').value = depEl.dataset.id;
    document.getElementById('heartbeatUrl').value = depEl.dataset.heartbeatUrl || '';
    document.getElementById('heartbeatInterval').value = depEl.dataset.heartbeatInterval || '60';
    document.getElementById('heartbeatMethod').value = depEl.dataset.heartbeatMethod || 'GET';
    document.getElementById('heartbeatExpectStatus').value = depEl.dataset.heartbeatExpectStatus || '';
    document.getElementById('heartbeatExpectBody').value = depEl.dataset.heartbeatExpectBody || '';
    document.getElementById('heartbeatBody').value = depEl.dataset.heartbeatBody || '';

    // Parse headers JSON
    try {
        const headers = depEl.dataset.heartbeatHeaders;
        if (headers) {
            document.getElementById('heartbeatHeaders').value = JSON.stringify(JSON.parse(headers), null, 2);
        } else {
            document.getElementById('heartbeatHeaders').value = '';
        }
    } catch {
        document.getElementById('heartbeatHeaders').value = '';
    }

    document.getElementById('heartbeatModal').style.display = 'flex';
}

async function clearHeartbeat() {
    const id = document.getElementById('heartbeatDepId').value;

    try {
        const res = await fetch(`/api/dependencies/${id}/heartbeat`, {method: 'DELETE'});
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to clear heartbeat');
        }
    } catch (err) {
        alert('Network error');
    }
}

document.getElementById('heartbeatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('heartbeatDepId').value;
    const url = document.getElementById('heartbeatUrl').value;
    const interval = parseInt(document.getElementById('heartbeatInterval').value, 10);
    const method = document.getElementById('heartbeatMethod').value;
    const expectStatus = document.getElementById('heartbeatExpectStatus').value;
    const expectBody = document.getElementById('heartbeatExpectBody').value;
    const body = document.getElementById('heartbeatBody').value;
    const headersText = document.getElementById('heartbeatHeaders').value.trim();

    if (!url) {
        await clearHeartbeat();
        return;
    }

    if (!interval || interval < 10) {
        alert('Interval must be at least 10 seconds');
        return;
    }

    // Parse headers JSON if provided
    let headers = null;
    if (headersText) {
        try {
            headers = JSON.parse(headersText);
        } catch (err) {
            alert('Invalid JSON in custom headers');
            return;
        }
    }

    const payload = {
        url,
        interval,
        method: method || 'GET'
    };

    if (headers) payload.headers = headers;
    if (body) payload.body = body;
    if (expectStatus) payload.expect_status = expectStatus;
    if (expectBody) payload.expect_body = expectBody;

    try {
        const res = await fetch(`/api/dependencies/${id}/heartbeat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to configure heartbeat');
        }
    } catch (err) {
        alert('Network error');
    }
});

document.getElementById('heartbeatModal').addEventListener('click', (e) => {
    if (e.target.id === 'heartbeatModal') closeModal('heartbeatModal');
});

async function deleteDependency(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

    try {
        const res = await fetch(`/api/dependencies/${id}`, {method: 'DELETE'});
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to delete dependency');
        }
    } catch (err) {
        alert('Network error');
    }
}

// Import handling
document.getElementById('importFile').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm('This will import data from the file. Existing data will NOT be replaced, new entries will be created. Continue?')) {
        e.target.value = '';
        return;
    }

    const resultDiv = document.getElementById('importResult');
    resultDiv.style.display = 'block';
    resultDiv.className = 'import-result loading';
    resultDiv.innerHTML = 'Importing...';

    try {
        const content = await file.text();
        const res = await fetch('/api/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: content
        });

        const data = await res.json();

        if (res.ok) {
            resultDiv.className = 'import-result success';
            resultDiv.innerHTML = `
                <strong>Import completed!</strong><br>
                Systems: ${data.systems_imported}<br>
                Dependencies: ${data.dependencies_imported}<br>
                Logs: ${data.logs_imported}
                ${data.errors && data.errors.length ? '<br><br>Warnings:<br>' + data.errors.join('<br>') : ''}
            `;
            setTimeout(() => location.reload(), 3000);
        } else {
            resultDiv.className = 'import-result error';
            resultDiv.innerHTML = `<strong>Import failed:</strong> ${data.error || 'Unknown error'}`;
        }
    } catch (err) {
        resultDiv.className = 'import-result error';
        resultDiv.innerHTML = `<strong>Error:</strong> ${err.message}`;
    }

    e.target.value = '';
});

// ========== Webhooks ==========

let webhooksData = [];

async function loadWebhooks() {
    const container = document.getElementById('webhooksList');
    try {
        const res = await fetch('/api/webhooks');
        if (!res.ok) throw new Error('Failed to load webhooks');
        webhooksData = await res.json();
        renderWebhooks();
    } catch (err) {
        container.innerHTML = '<div class="error">Failed to load webhooks</div>';
    }
}

function renderWebhooks() {
    const container = document.getElementById('webhooksList');
    if (!webhooksData || webhooksData.length === 0) {
        container.innerHTML = '<p class="no-items">No webhooks configured</p>';
        return;
    }

    container.innerHTML = webhooksData.map(w => `
        <div class="webhook-item ${w.enabled ? '' : 'disabled'}">
            <div class="webhook-info">
                <span class="webhook-name">${escapeHtml(w.name)}</span>
                <span class="webhook-type">${w.type}</span>
                <span class="webhook-url" title="${escapeHtml(w.url)}">${truncateUrl(w.url)}</span>
                ${w.enabled ? '<span class="badge badge-green">Active</span>' : '<span class="badge badge-gray">Disabled</span>'}
            </div>
            <div class="webhook-actions">
                <button class="btn btn-tiny" onclick="testWebhook(${w.id})">Test</button>
                <button class="btn btn-tiny" onclick="openEditWebhookModal(${w.id})">Edit</button>
                <button class="btn btn-tiny btn-danger" onclick="deleteWebhook(${w.id}, '${escapeHtml(w.name)}')">Delete</button>
            </div>
        </div>
    `).join('');
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function truncateUrl(url) {
    if (!url) return '';
    if (url.length <= 50) return url;
    return url.substring(0, 47) + '...';
}

function openAddWebhookModal() {
    document.getElementById('addWebhookName').value = '';
    document.getElementById('addWebhookType').value = 'generic';
    document.getElementById('addWebhookUrl').value = '';
    document.getElementById('addWebhookEnabled').checked = true;
    document.getElementById('addWebhookModal').style.display = 'flex';
}

document.getElementById('addWebhookForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        name: document.getElementById('addWebhookName').value,
        type: document.getElementById('addWebhookType').value,
        url: document.getElementById('addWebhookUrl').value,
        enabled: document.getElementById('addWebhookEnabled').checked,
        events: ['status_change']
    };

    try {
        const res = await fetch('/api/webhooks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (res.ok) {
            closeModal('addWebhookModal');
            loadWebhooks();
        } else {
            const err = await res.json();
            alert(err.error || 'Failed to create webhook');
        }
    } catch (err) {
        alert('Network error');
    }
});

document.getElementById('addWebhookModal').addEventListener('click', (e) => {
    if (e.target.id === 'addWebhookModal') closeModal('addWebhookModal');
});

function openEditWebhookModal(id) {
    const webhook = webhooksData.find(w => w.id === id);
    if (!webhook) return;

    document.getElementById('editWebhookId').value = webhook.id;
    document.getElementById('editWebhookName').value = webhook.name;
    document.getElementById('editWebhookType').value = webhook.type;
    document.getElementById('editWebhookUrl').value = webhook.url;
    document.getElementById('editWebhookEnabled').checked = webhook.enabled;
    document.getElementById('editWebhookModal').style.display = 'flex';
}

document.getElementById('editWebhookForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editWebhookId').value;
    const data = {
        name: document.getElementById('editWebhookName').value,
        type: document.getElementById('editWebhookType').value,
        url: document.getElementById('editWebhookUrl').value,
        enabled: document.getElementById('editWebhookEnabled').checked,
        events: ['status_change']
    };

    try {
        const res = await fetch(`/api/webhooks/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (res.ok) {
            closeModal('editWebhookModal');
            loadWebhooks();
        } else {
            const err = await res.json();
            alert(err.error || 'Failed to update webhook');
        }
    } catch (err) {
        alert('Network error');
    }
});

document.getElementById('editWebhookModal').addEventListener('click', (e) => {
    if (e.target.id === 'editWebhookModal') closeModal('editWebhookModal');
});

async function deleteWebhook(id, name) {
    if (!confirm(`Are you sure you want to delete webhook "${name}"?`)) return;

    try {
        const res = await fetch(`/api/webhooks/${id}`, {method: 'DELETE'});
        if (res.ok) {
            loadWebhooks();
        } else {
            const err = await res.json();
            alert(err.error || 'Failed to delete webhook');
        }
    } catch (err) {
        alert('Network error');
    }
}

async function testWebhook(id) {
    try {
        const res = await fetch(`/api/webhooks/${id}/test`, {method: 'POST'});
        if (res.ok) {
            alert('Test notification sent!');
        } else {
            const err = await res.json();
            alert(err.error || 'Failed to send test notification');
        }
    } catch (err) {
        alert('Network error');
    }
}

// Load webhooks on page load
loadWebhooks();
</script>
{{end}}
