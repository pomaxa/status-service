{{define "title"}}Admin{{end}}

{{define "content"}}
<div class="page-header">
    <h1>Administration</h1>
</div>

<section class="card">
    <h2>Backup & Restore</h2>
    <div class="backup-actions">
        <div class="backup-group">
            <h4>Export Data</h4>
            <p class="backup-desc">Download all systems, dependencies, and history as JSON file.</p>
            <div class="backup-buttons">
                <a href="/api/export" class="btn btn-primary" download>Export All</a>
                <a href="/api/export/logs" class="btn btn-small" download>Export Logs Only</a>
            </div>
        </div>
        <div class="backup-group">
            <h4>Import Data</h4>
            <p class="backup-desc">Restore data from a previously exported JSON file.</p>
            <div class="backup-buttons">
                <input type="file" id="importFile" accept=".json" style="display:none">
                <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">Import from File</button>
            </div>
        </div>
    </div>
    <div id="importResult" class="import-result" style="display:none"></div>
</section>

<section class="card">
    <h2>Add New System</h2>
    <form id="addSystemForm" class="admin-form">
        <div class="form-row">
            <input type="text" name="name" placeholder="System name" required>
            <input type="text" name="description" placeholder="Description (optional)">
        </div>
        <div class="form-row">
            <input type="url" name="url" placeholder="System URL (optional)">
            <input type="text" name="owner" placeholder="Owner/Team (optional)">
        </div>
        <button type="submit" class="btn btn-primary">Add System</button>
    </form>
</section>

<!-- Edit System Modal -->
<div id="editModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>Edit System</h3>
        <form id="editSystemForm" class="admin-form">
            <input type="hidden" id="editSystemId">
            <div class="form-row">
                <input type="text" id="editName" placeholder="System name" required>
                <input type="text" id="editDescription" placeholder="Description (optional)">
            </div>
            <div class="form-row">
                <input type="url" id="editUrl" placeholder="System URL (optional)">
                <input type="text" id="editOwner" placeholder="Owner/Team (optional)">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

{{if .Systems}}
<section class="card">
    <h2>Manage Systems</h2>
    {{range .Systems}}
    <div class="admin-system" data-id="{{.ID}}" data-name="{{.Name}}" data-description="{{.Description}}" data-url="{{.URL}}" data-owner="{{.Owner}}">
        <div class="admin-system-header">
            <span class="status-dot {{statusClass .Status}}"></span>
            <strong>{{.Name}}</strong>
            {{if .Owner}}<span class="owner-badge">{{.Owner}}</span>{{end}}
            {{if .URL}}<a href="{{.URL}}" target="_blank" class="url-link">Link</a>{{end}}
            <div class="admin-actions">
                <button class="btn btn-small" onclick="openEditModal(this.closest('.admin-system'))">Edit</button>
                <button class="btn btn-small btn-danger" onclick="deleteSystem({{.ID}}, '{{.Name}}')">Delete</button>
            </div>
        </div>

        <div class="admin-dependencies">
            <div class="dep-header">
                <h4>Dependencies</h4>
                <button class="btn btn-small" onclick="addDependency({{.ID}})">+ Add</button>
            </div>

            {{if .Dependencies}}
            <ul class="admin-dep-list">
                {{range .Dependencies}}
                <li>
                    <span class="status-dot {{statusClass .Status}}"></span>
                    <span class="dep-name">{{.Name}}</span>
                    {{if .HeartbeatURL}}
                    <span class="heartbeat-badge">HB: {{.HeartbeatInterval}}s</span>
                    {{end}}
                    <div class="dep-actions">
                        <button class="btn btn-tiny" onclick="editDependency({{.ID}}, '{{.Name}}', '{{.Description}}')">Edit</button>
                        <button class="btn btn-tiny" onclick="configureHeartbeat({{.ID}}, '{{.HeartbeatURL}}', {{.HeartbeatInterval}})">Heartbeat</button>
                        <button class="btn btn-tiny btn-danger" onclick="deleteDependency({{.ID}}, '{{.Name}}')">Delete</button>
                    </div>
                </li>
                {{end}}
            </ul>
            {{else}}
            <p class="no-deps">No dependencies configured</p>
            {{end}}
        </div>
    </div>
    {{end}}
</section>
{{end}}
{{end}}

{{define "scripts"}}
<script>
document.getElementById('addSystemForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = e.target.name.value;
    const description = e.target.description.value;
    const url = e.target.url.value;
    const owner = e.target.owner.value;

    try {
        const res = await fetch('/api/systems', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description, url, owner})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to create system');
        }
    } catch (err) {
        alert('Network error');
    }
});

function openEditModal(systemEl) {
    document.getElementById('editSystemId').value = systemEl.dataset.id;
    document.getElementById('editName').value = systemEl.dataset.name;
    document.getElementById('editDescription').value = systemEl.dataset.description || '';
    document.getElementById('editUrl').value = systemEl.dataset.url || '';
    document.getElementById('editOwner').value = systemEl.dataset.owner || '';
    document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

document.getElementById('editSystemForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editSystemId').value;
    const name = document.getElementById('editName').value;
    const description = document.getElementById('editDescription').value;
    const url = document.getElementById('editUrl').value;
    const owner = document.getElementById('editOwner').value;

    try {
        const res = await fetch(`/api/systems/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description, url, owner})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to update system');
        }
    } catch (err) {
        alert('Network error');
    }
});

// Close modal on outside click
document.getElementById('editModal').addEventListener('click', (e) => {
    if (e.target.id === 'editModal') closeEditModal();
});

async function deleteSystem(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"? This will also delete all its dependencies.`)) return;

    try {
        const res = await fetch(`/api/systems/${id}`, {method: 'DELETE'});
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to delete system');
        }
    } catch (err) {
        alert('Network error');
    }
}

async function addDependency(systemId) {
    const name = prompt('Dependency name:');
    if (!name) return;

    const description = prompt('Description (optional):') || '';

    try {
        const res = await fetch(`/api/systems/${systemId}/dependencies`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, description})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to create dependency');
        }
    } catch (err) {
        alert('Network error');
    }
}

async function editDependency(id, name, description) {
    const newName = prompt('Dependency name:', name);
    if (!newName) return;

    const newDesc = prompt('Description:', description) || '';

    try {
        const res = await fetch(`/api/dependencies/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: newName, description: newDesc})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to update dependency');
        }
    } catch (err) {
        alert('Network error');
    }
}

async function configureHeartbeat(id, currentUrl, currentInterval) {
    const url = prompt('Heartbeat URL (leave empty to disable):', currentUrl || '');

    if (url === null) return; // cancelled

    if (url === '') {
        // Clear heartbeat
        try {
            const res = await fetch(`/api/dependencies/${id}/heartbeat`, {method: 'DELETE'});
            if (res.ok) {
                location.reload();
            } else {
                const data = await res.json();
                alert(data.error || 'Failed to clear heartbeat');
            }
        } catch (err) {
            alert('Network error');
        }
        return;
    }

    const interval = parseInt(prompt('Check interval (seconds):', currentInterval || '60'), 10);
    if (!interval || interval < 10) {
        alert('Interval must be at least 10 seconds');
        return;
    }

    try {
        const res = await fetch(`/api/dependencies/${id}/heartbeat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url, interval})
        });

        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to configure heartbeat');
        }
    } catch (err) {
        alert('Network error');
    }
}

async function deleteDependency(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

    try {
        const res = await fetch(`/api/dependencies/${id}`, {method: 'DELETE'});
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to delete dependency');
        }
    } catch (err) {
        alert('Network error');
    }
}

// Import handling
document.getElementById('importFile').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!confirm('This will import data from the file. Existing data will NOT be replaced, new entries will be created. Continue?')) {
        e.target.value = '';
        return;
    }

    const resultDiv = document.getElementById('importResult');
    resultDiv.style.display = 'block';
    resultDiv.className = 'import-result loading';
    resultDiv.innerHTML = 'Importing...';

    try {
        const content = await file.text();
        const res = await fetch('/api/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: content
        });

        const data = await res.json();

        if (res.ok) {
            resultDiv.className = 'import-result success';
            resultDiv.innerHTML = `
                <strong>Import completed!</strong><br>
                Systems: ${data.systems_imported}<br>
                Dependencies: ${data.dependencies_imported}<br>
                Logs: ${data.logs_imported}
                ${data.errors && data.errors.length ? '<br><br>Warnings:<br>' + data.errors.join('<br>') : ''}
            `;
            setTimeout(() => location.reload(), 3000);
        } else {
            resultDiv.className = 'import-result error';
            resultDiv.innerHTML = `<strong>Import failed:</strong> ${data.error || 'Unknown error'}`;
        }
    } catch (err) {
        resultDiv.className = 'import-result error';
        resultDiv.innerHTML = `<strong>Error:</strong> ${err.message}`;
    }

    e.target.value = '';
});
</script>
{{end}}
